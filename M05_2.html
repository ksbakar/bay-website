<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.2">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Week 10: Goldilocks – Bayesian Statistical Methods in Medicine &amp; Health</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./brief_module_06.html" rel="next">
<link href="./M05_1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-07c16812f08c4a1591d6ec4fc46327fa.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-8da5b4427184b79ecddefad3d342027e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<script src="site_libs/viz-1.8.2/viz.js"></script>

<link href="site_libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">

<script src="site_libs/grViz-binding-1.0.11/grViz.js"></script>

<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./M05_2.html">Week 10: <strong>Goldilocks</strong></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bayesian Statistical Methods in Medicine &amp; Health</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Preface</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Introduction</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./installation_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Software Installation Guide</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./brief_module_01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Module 1:</strong> Bayesian Dreams!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M01_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 1: <strong>Navigating Evidence</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M01_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 2: <strong>Bayesian Inference</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./brief_module_02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Module 2:</strong> Chaotics?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M02_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 3: <strong>Prior and Posterior</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M02_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 4: <strong>Generative Models and Tools</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./brief_module_03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Module 3:</strong> Bayeswatch - Gaussian!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M03_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 5: <strong>Logical Connections</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M03_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 6: <strong>Prior Tweaks and More</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./brief_module_04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Module 4:</strong> Bayeswatch - Non Gaussian!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M04_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 7: <strong>Non-Gaussian</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M04_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 8: <strong>More on Non-Gaussian</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./brief_module_05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Module 5:</strong> Clusterphobia?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M05_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 9: <strong>Cluster Smart with Bayes</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M05_2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Week 10: <strong>Goldilocks</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./brief_module_06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Module 6:</strong> Wander into the Wonder!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M06_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 11: <strong>Size Matters!</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./M06_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 12: <strong>Discover the Perfect Spell!</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learnings" id="toc-learnings" class="nav-link active" data-scroll-target="#learnings">Learnings</a></li>
  <li><a href="#partial-pooling-with-random-slope-intercept" id="toc-partial-pooling-with-random-slope-intercept" class="nav-link" data-scroll-target="#partial-pooling-with-random-slope-intercept">Partial Pooling with Random Slope &amp; Intercept</a>
  <ul class="collapse">
  <li><a href="#model-specification" id="toc-model-specification" class="nav-link" data-scroll-target="#model-specification">Model Specification</a></li>
  <li><a href="#prior-distributions" id="toc-prior-distributions" class="nav-link" data-scroll-target="#prior-distributions">Prior Distributions</a></li>
  <li><a href="#r-stan-brm-example" id="toc-r-stan-brm-example" class="nav-link" data-scroll-target="#r-stan-brm-example">R-Stan (brm) Example</a></li>
  </ul></li>
  <li><a href="#partial-pooling-with-only-random-slope" id="toc-partial-pooling-with-only-random-slope" class="nav-link" data-scroll-target="#partial-pooling-with-only-random-slope">Partial Pooling with Only Random Slope</a>
  <ul class="collapse">
  <li><a href="#model-specification-1" id="toc-model-specification-1" class="nav-link" data-scroll-target="#model-specification-1">Model Specification</a></li>
  <li><a href="#r-stan-brm-example-1" id="toc-r-stan-brm-example-1" class="nav-link" data-scroll-target="#r-stan-brm-example-1">R-Stan (brm) Example</a></li>
  </ul></li>
  <li><a href="#partial-pooling-with-binary-outcome" id="toc-partial-pooling-with-binary-outcome" class="nav-link" data-scroll-target="#partial-pooling-with-binary-outcome">Partial Pooling with Binary Outcome</a>
  <ul class="collapse">
  <li><a href="#toe-nail-data" id="toc-toe-nail-data" class="nav-link" data-scroll-target="#toe-nail-data">Toe Nail Data</a></li>
  <li><a href="#model-development" id="toc-model-development" class="nav-link" data-scroll-target="#model-development">Model Development</a></li>
  <li><a href="#r-stan-brm-example-2" id="toc-r-stan-brm-example-2" class="nav-link" data-scroll-target="#r-stan-brm-example-2">R-Stan (brm) Example</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#live-tutorial-and-discussion" id="toc-live-tutorial-and-discussion" class="nav-link" data-scroll-target="#live-tutorial-and-discussion">Live tutorial and discussion</a></li>
  <li><a href="#tutorial-exercises" id="toc-tutorial-exercises" class="nav-link" data-scroll-target="#tutorial-exercises">Tutorial Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 10: <strong>Goldilocks</strong></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<iframe width="500" height="300" src="https://www.youtube.com/embed/5oM03W87Rfs" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
</iframe>
<section id="learnings" class="level2">
<h2 class="anchored" data-anchor-id="learnings">Learnings</h2>
<ul>
<li><strong>Outcomes</strong></li>
</ul>
<p>– LO2: Demonstrate how to specify and fit simple Bayesian models with appropriate attention to the role of the prior distribution and the data model.</p>
<p>– LO4: Demonstrate proficiency in using statistical software packages (R) to specify and fit models, assess model fit, detect and remediate non-convergence, and compare models.</p>
<p>– LO5: Engage in specifying, checking and interpreting Bayesian statistical analyses in practical problems using effective communication with health and medical investigators.</p>
<ul>
<li><strong>Objectives</strong></li>
</ul>
<p>By the end of this week you should be able to:</p>
<p>– Gain insight into different versions of the partial pooling model.</p>
<p>– Construct Bayesian hierarchical models for binary outcome.</p>
<p>– Interpret real-life clustered data problems in Bayesian context.</p>
</section>
<section id="partial-pooling-with-random-slope-intercept" class="level2">
<h2 class="anchored" data-anchor-id="partial-pooling-with-random-slope-intercept">Partial Pooling with Random Slope &amp; Intercept</h2>
<iframe width="500" height="300" src="https://www.youtube.com/embed/gFsj85LbQP8" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
</iframe>
<p>Recall the C-reactive protein (CRP) data, where we are interested in modelling the daily progression of C-reactive protein levels in patients admitted to the intensive care unit during the first six days following admission. Since each patient has multiple CRP measurements over time, and we expect substantial variability between patients in their baseline inflammation levels, we use a Bayesian hierarchical (multilevel) model, such as in our last lecture we used the partial pooling model with a random intercept to account for individual differences while borrowing strength across the patient population.</p>
<!--

At the first level of the model (within-patient), we assume that each observed CRP measurement for patient $j$ on day $i$, denoted $\text{CRP}_{ij}$, is normally distributed around a patient-specific mean. This mean is composed of a global intercept $\beta_0$, a patient-specific deviation $\beta_{0j}$ (the random intercept), 

-->
<p>Now, what if we are interested to know different types of heterogeneous effects that may arise from the clustering. For example, we want to allow both varying baseline CRP levels and also its rate of change over time to differe among patients. To address this we can use a another version of partial pooling, where both intercepts and slopes vary by patient.</p>
<p>In the random intercept and slope model, we allow both (i) the intercept (baseline CRP level on day 0 or 1) and (ii) the slope (how CRP changes across days in the ICU) to vary by patient.</p>
<p>This accounts for the biological intuition that some patients start with higher or lower CRP levels and the trajectory of inflammation (rise or fall of CRP over time) can differ across individuals. This kind of model captures heterogeneous responses over time while still sharing information across patients through partial pooling.</p>
<section id="model-specification" class="level3">
<h3 class="anchored" data-anchor-id="model-specification">Model Specification</h3>
<p>In this hierarchical Bayesian model, we aim to describe how C-reactive protein (CRP) levels (in log scale) evolve over time in critically ill patients admitted to the ICU. The model accounts for both population-level effects and patient-specific deviations, allowing us to flexibly capture heterogeneity in inflammation patterns across individuals. The observed CRP level (in log scale) for patient <span class="math inline">\(j\)</span> on day <span class="math inline">\(i\)</span>, denoted <span class="math inline">\(\text{log(CRP)}_{ij}\)</span>, is modelled as normally distributed around a mean, say <span class="math inline">\(\mu_{ij}\)</span>, with constant residual variance <span class="math inline">\(\sigma^2\)</span>. This forms the first level of the model, reflecting within-patient variation.</p>
<p>The mean</p>
<p><span class="math display">\[
\mu_{ij}=\beta_0 + \beta_{0j} + (\beta_1 + \beta_{1j}) \cdot \text{Day}_{ij} + \mathbf{x}_{ij} \boldsymbol{\beta}
\]</span></p>
<p>represents the expected log-CRP level and is composed of several components. It includes a global intercept <span class="math inline">\(\beta_0\)</span>, a patient-specific random intercept <span class="math inline">\(\beta_{0j}\)</span>, a global slope for time <span class="math inline">\(\beta_1\)</span> (reflecting the average effect of ICU day), and a patient-specific random slope <span class="math inline">\(\beta_{1j}\)</span>, which captures how the rate of CRP change over time varies across patients. The model also includes a set of fixed effects <span class="math inline">\(\boldsymbol{\beta}\)</span> corresponding to patient-level covariates such as age, sex, sepsis category, antibiotic timing, and ICU discharge status. These covariates are encoded in the vector <span class="math inline">\(\mathbf{x}_{ij}\)</span>, and their contribution to the mean is given by the inner product <span class="math inline">\(\mathbf{x}_{ij}\boldsymbol{\beta}\)</span>.</p>
<p>At the second level of the model, the random intercept <span class="math inline">\(\beta_{0j}\)</span> and random slope <span class="math inline">\(\beta_{1j}\)</span> for each patient are modeled jointly as a bivariate normal distribution centered at zero. This distribution is parameterised by a variance-covariance matrix that includes the variance of the random intercepts <span class="math inline">\(\sigma_0^2\)</span>, the variance of the random slopes <span class="math inline">\(\sigma_1^2\)</span>, and the correlation <span class="math inline">\(\rho\)</span> between them. This structure allows for partial pooling: each patient’s intercept and slope are informed not only by their own data but also by the overall distribution of intercepts and slopes across all patients. The correlation term <span class="math inline">\(\rho\)</span> enables us to capture whether patients with higher baseline CRP levels tend to experience faster or slower changes in inflammation over time.</p>
<p>We write the hierarchical structure of the random slope and intercept model as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\text{log(CRP)}_{ij} &amp;\sim N(\beta_0 + \beta_{0j} + (\beta_1 + \beta_{1j}) \cdot \text{Day}_{ij} + \mathbf{x}_{ij} \boldsymbol{\beta}, \sigma^2) \\
\begin{bmatrix}
\beta_{0j} \\
\beta_{1j}
\end{bmatrix}
&amp;\sim \text{MVN}\left(
\begin{bmatrix}
0 \\
0
\end{bmatrix},
\Sigma = \begin{bmatrix}
\sigma_0^2 &amp; \rho \sigma_0 \sigma_1 \\
\rho \sigma_0 \sigma_1 &amp; \sigma_1^2
\end{bmatrix}
\right)
\end{aligned}
\]</span></p>
<p>where,</p>
<p>– <span class="math inline">\(\beta_0\)</span>: global intercept. – <span class="math inline">\(\beta_1\)</span>: global slope for time (Day). – <span class="math inline">\(\beta_{0j}\)</span>, <span class="math inline">\(\beta_{1j}\)</span>: patient-specific random deviations (random effects). – <span class="math inline">\(\boldsymbol{\beta}\)</span>: fixed effects for other covariates (e.g.&nbsp;Age, Sex, and Antibiotic). – <span class="math inline">\(\sigma\)</span>: residual standard deviation. – The random effects for intercept and slope are correlated via <span class="math inline">\(\rho\)</span>.</p>
<p>Here, each patient has their own intercept and slope, but those are not estimated in isolation. Instead, patient-specific estimates are regularised (shrunken) toward the population average. This balances overfitting (too much flexibility) and underfitting (forcing everyone to follow the same trend).</p>
<p>We can see, a random intercept allows each patient to have a unique baseline CRP on ICU Day 1. Whereas, a random slope allows each patient to have their own CRP trajectory across the six ICU days, e.g., fast responders vs.&nbsp;slow responders vs.&nbsp;worsening patients. Furthermore, the fixed effects (age, sex, antibiotics, etc.) apply consistently across patients and help explain variability beyond time and patient ID.</p>
<p>One of the key benefits of using random slope over random intercept alone is to captures individual disease dynamics, i.e., in our example the different rates of inflammation. It also provides more accurate modelling of time trends without assuming identical change for all and provides better predictions, especially over time within individuals.</p>
</section>
<section id="prior-distributions" class="level3">
<h3 class="anchored" data-anchor-id="prior-distributions">Prior Distributions</h3>
<p>Now let us discuss the model and related prior distributions and explain the priors step-by-step: <span class="math inline">\(\beta_0, \beta_1 \sim \mathcal{N}(0, 10^2)\)</span> are mainly the weakly informative priors. The prior <span class="math inline">\(\boldsymbol{\beta} \sim \mathcal{N}(0, 10^2 I)\)</span> is placed on the coefficients of other fixed effects: age, sex, sepsis type, antibiotic timing, and discharge status. Again, it’s weakly informative and assumes we don’t have strong prior knowledge, but that extremely large effect sizes are unlikely.</p>
<p>Now for the random effects (patient-level intercept and slope), i.e.,</p>
<p><span class="math display">\[
\begin{bmatrix} \beta_{0j} \\ \beta_{1j} \end{bmatrix} \sim \text{MVN} \left( \begin{bmatrix} 0 \\ 0 \end{bmatrix}, \Sigma \right)
\]</span></p>
<p>This is a bivariate normal distribution, modelling the patient-specific deviations in intercept (<span class="math inline">\(\beta_{0j}\)</span>) and slope (<span class="math inline">\(\beta_{1j}\)</span>) from the global values. It allows each patient to have their own baseline CRP and rate of change over time. The covariance matrix <span class="math inline">\(\Sigma\)</span> is:</p>
<p><span class="math display">\[
  \Sigma =
  \begin{bmatrix}
  \sigma_0^2 &amp; \rho \sigma_0 \sigma_1 \\
  \rho \sigma_0 \sigma_1 &amp; \sigma_1^2
  \end{bmatrix}
\]</span></p>
<p>Note that options for <span class="math inline">\(\Sigma\)</span> includes the Inverse-Wishart distribution, which is the conjugate prior for the covariance matrix of a multivariate/bivariate normal model, and priors set not directly on the covariance matrix but on a decomposition of the matrix, in particular, the Cholesky decomposition can be used in this context. Hence, this structure allows us to estimate variability in baseline CRP (<span class="math inline">\(\sigma_0\)</span>), CRP trajectory over time (<span class="math inline">\(\sigma_1\)</span>) and to learn the correlation (<span class="math inline">\(\rho\)</span>) between baseline and change. Now, we use half-Cauchy distribution for <span class="math inline">\(\sigma_0\)</span>, <span class="math inline">\(\sigma_1\)</span> and <span class="math inline">\(\sigma\)</span>. As we have already discussed in our previous modules that half-Cauchy is commonly used as a weakly informative prior on scale parameters.</p>
<p>Now, for the correlation (<span class="math inline">\(\rho\)</span>), LKJ (Lewandowski–Kurowicka–Joe) prior is a standard prior in Bayesian hierarchical models (<span class="citation" data-cites="LEWANDOWSKI20091989">Lewandowski, Kurowicka, and Joe (<a href="references.html#ref-LEWANDOWSKI20091989" role="doc-biblioref">2009</a>)</span>). And a shape parameter of 2, gently favors correlations near 0 (i.e., assumes weak prior belief in strong correlation), but still allows the model to estimate a strong correlation if present in the data.</p>
<p>Hence, we can write these as:</p>
<p><span class="math display">\[
\begin{aligned}
\beta_0, \beta_1 &amp;\sim N(0, 10^2); \\
\boldsymbol{\beta} &amp;\sim N(0, 10^2 I) \\
\sigma, \sigma_0, \sigma_1 &amp;\sim \text{Half-Cauchy}(0, 1); \\
\rho &amp;\sim \text{LKJ}(2)
\end{aligned}
\]</span></p>
<p>Based on the equations we can draw the DAG as:</p>
<div class="cell">
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-7a48089db53dee63954b" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-7a48089db53dee63954b">{"x":{"diagram":"\n  digraph DAG {\n    rankdir = LR;\n    fontsize = 10;\n    node [fontname = Helvetica];\n\n    # Observed Data\n    n_obs     [label = \"i = 1,...,nⱼ\\n j = 1,...,J\", shape = note, style = dashed, fontsize = 10]\n    CRP       [label = \"log(CRP[i,j])\", shape = ellipse, style = filled, fillcolor = lightcoral]\n    Day       [label = \"Day[i,j]\", shape = ellipse, style = filled, fillcolor = lightblue]\n    x         [label = \"x[i,j]\", shape = ellipse, style = filled, fillcolor = lightblue]\n\n    # Fixed Effects\n    beta_0    [label = \"β₀\\n(Global Intercept)\", shape = box, style = filled, fillcolor = lightgrey]\n    beta_1    [label = \"β₁\\n(Global Slope)\", shape = box, style = filled, fillcolor = lightgrey]\n    beta      [label = \"β\\n(Covariate Coefs)\", shape = box, style = filled, fillcolor = lightgrey]\n\n    # Priors for Fixed Effects\n    prior_beta_0 [label = \"Prior: β₀ ~ N(0, 10²)\", shape = box, style = dashed, fillcolor = lightyellow]\n    prior_beta_1 [label = \"Prior: β₁ ~ N(0, 10²)\", shape = box, style = dashed, fillcolor = lightyellow]\n    prior_beta   [label = \"Prior: β ~ N(0, 10² I)\", shape = box, style = dashed, fillcolor = lightyellow]\n\n    # Random Effects\n    beta_0j   [label = \"β₀ⱼ\\n(Random Intercept)\", shape = box, style = filled, fillcolor = lightyellow]\n    beta_1j   [label = \"β₁ⱼ\\n(Random Slope)\", shape = box, style = filled, fillcolor = lightyellow]\n\n    # Random Effects Hyperparameters\n    Sigma     [label = \"Σ\\n(MVN Cov Matrix)\", shape = box, style = filled, fillcolor = seagreen1]\n    sigma_0   [label = \"σ₀ ~ Half-Cauchy(0,1)\", shape = box, style = filled, fillcolor = seagreen1]\n    sigma_1   [label = \"σ₁ ~ Half-Cauchy(0,1)\", shape = box, style = filled, fillcolor = seagreen1]\n    rho       [label = \"ρ ~ LKJ(2)\", shape = box, style = filled, fillcolor = seagreen1]\n\n    # Residual SD\n    sigma     [label = \"σ\\n(Residual SD)\", shape = box, style = filled, fillcolor = lightgrey]\n    prior_sigma [label = \"Prior: σ ~ Half-Cauchy(0,1)\", shape = box, style = dashed, fillcolor = lightyellow]\n\n    # Edges: Observed -> Outcome\n    Day -> CRP\n    x   -> CRP\n\n    # Edges: Fixed Effects -> Outcome\n    beta_0 -> CRP\n    beta_1 -> CRP\n    beta   -> CRP\n\n    # Edges: Random Effects -> Outcome\n    beta_0j -> CRP\n    beta_1j -> CRP\n\n    # Edge: Residual SD -> Outcome\n    sigma -> CRP\n\n    # Priors -> Fixed Effects\n    prior_beta_0 -> beta_0\n    prior_beta_1 -> beta_1\n    prior_beta   -> beta\n\n    # Priors -> Residual SD\n    prior_sigma -> sigma\n\n    # Hyperparams -> Cov Matrix\n    sigma_0 -> Sigma\n    sigma_1 -> Sigma\n    rho     -> Sigma\n\n    # Cov Matrix -> Random Effects\n    Sigma -> beta_0j\n    Sigma -> beta_1j\n  }\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="r-stan-brm-example" class="level3">
<h3 class="anchored" data-anchor-id="r-stan-brm-example">R-Stan (brm) Example</h3>
<p>Now we will explore R code to apply these types of model for our data on C-reactive protein (CRP). We will develop the R code based on the DAG we developed. This model estimates CRP (in log scale) using a mix of demographic and clinical predictors while accounting for individual-level variation over time. It includes both fixed effects (shared across the population) and random effects (individual-specific intercepts and slopes for time, i.e., <code>Day</code>). The outcome is modeled assuming a Gaussian distribution, with an identity link function. A total of 432 observations from 72 individuals were analysed. To represent the partial pooling model with random slop and intercept model, we use <code>(1 + Day | ID)</code> inside the <code>formula</code> argument of <code>brm</code> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>crp_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"crp_data_complete.csv"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>crp_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ID =</span> crp_data<span class="sc">$</span>ID,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">CRP =</span> crp_data<span class="sc">$</span>crp,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">CRP_log =</span> <span class="fu">log</span>(crp_data<span class="sc">$</span>crp),</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Day =</span> crp_data<span class="sc">$</span>day,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Antibiotic =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>antib_1h),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Age =</span> crp_data<span class="sc">$</span>age,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sex =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>SEX),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sepsis =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>SEPSIS),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Discharg =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>discharge_r)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sd"</span>),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">2</span>), <span class="at">class =</span> <span class="st">"cor"</span>),</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>crp_model_random_slope <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> CRP_log <span class="sc">~</span> Day <span class="sc">+</span> Age <span class="sc">+</span> Sex <span class="sc">+</span> Antibiotic <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> Day <span class="sc">|</span> ID),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> crp_data,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> priors,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">3</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">prior_summary</span>(crp_model_random_slope, <span class="at">all =</span> <span class="cn">FALSE</span>), <span class="at">show_df =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>b ~ normal(0, 10)
Intercept ~ normal(0, 10)
L ~ lkj_corr_cholesky(2)
&lt;lower=0&gt; sd ~ cauchy(0, 1)
&lt;lower=0&gt; sigma ~ cauchy(0, 1)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(crp_model_random_slope)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: CRP_log ~ Day + Age + Sex + Antibiotic + (1 + Day | ID) 
   Data: crp_data (Number of observations: 432) 
  Draws: 3 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 3000

Multilevel Hyperparameters:
~ID (Number of levels: 72) 
                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)          0.62      0.07     0.48     0.78 1.00     1160     1756
sd(Day)                0.20      0.02     0.16     0.24 1.01      474      483
cor(Intercept,Day)    -0.42      0.12    -0.63    -0.15 1.01      256      497

Regression Coefficients:
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept         3.49      0.33     2.87     4.15 1.00     1317     1660
Day              -0.11      0.03    -0.16    -0.06 1.01      572      757
Age              -0.01      0.00    -0.01     0.00 1.00     1316     1698
SexMale          -0.50      0.16    -0.80    -0.20 1.00     1040     1664
AntibioticYes    -0.20      0.15    -0.49     0.09 1.00      829     1193

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.41      0.02     0.38     0.44 1.00     1869     2348

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>In terms of population-level trends, CRP (in log scale) decreases significantly over time, with an average slope of -0.11 (95% credible interval: -0.16 to -0.06), indicating that inflammation, as measured by CRP, tends to reduce as patients progress through their hospital stay. Age has a small but consistent negative association with CRP, suggesting that older patients tend to have slightly lower CRP levels. Male patients also show significantly lower CRP compared to females, with an estimated difference of -0.5 (95% CI: -0.8 to -0.2). Antibiotic use is associated with a modest reduction in CRP, but the effect is not statistically conclusive.</p>
<p>The model includes random intercepts and slopes for each individual, capturing how baseline CRP and its trajectory over time differ from person to person. The estimated standard deviation of the intercepts is 0.62, and for the slopes (Day), it is 0.20, indicating meaningful between-subject variability. Importantly, the correlation between the intercept and the slope is -0.42, suggesting that individuals with higher baseline CRP levels tend to experience faster declines in CRP over time.</p>
<p>Lastly, the residual standard deviation (<span class="math inline">\(\sigma\)</span>) is estimated at 0.41, reflecting the variability in CRP that remains unexplained after accounting for both fixed and random effects. Model diagnostics (e.g., Rhat ≈ 1 and high effective sample sizes) indicate good convergence and reliable posterior estimation.</p>
<p>Now we can plot both random intercepts and slops with their 95% credible interaval as follows:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ranef_data <span class="ot">&lt;-</span> <span class="fu">ranef</span>(crp_model_random_slope)<span class="sc">$</span>ID[, , <span class="st">"Intercept"</span>] <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Estimate =</span> Estimate, <span class="at">Q2.5 =</span> Q2<span class="fl">.5</span>, <span class="at">Q97.5 =</span> Q97<span class="fl">.5</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>ranef_data<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="fu">factor</span>(ranef_data<span class="sc">$</span>ID, <span class="at">levels =</span> ranef_data<span class="sc">$</span>ID[<span class="fu">order</span>(ranef_data<span class="sc">$</span>Estimate)])</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ranef_data, <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Estimated Random Intercepts by Patient"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Patient ID"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Random Intercept Estimate (log-CRP scale)"</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="M05_2_files/figure-html/crp_random_slope_intercept_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">##</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>slope_data <span class="ot">&lt;-</span> <span class="fu">ranef</span>(crp_model_random_slope)<span class="sc">$</span>ID[, , <span class="st">"Day"</span>] <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Estimate =</span> Estimate, <span class="at">Q2.5 =</span> Q2<span class="fl">.5</span>, <span class="at">Q97.5 =</span> Q97<span class="fl">.5</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>slope_data<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="fu">factor</span>(slope_data<span class="sc">$</span>ID, <span class="at">levels =</span> slope_data<span class="sc">$</span>ID[<span class="fu">order</span>(slope_data<span class="sc">$</span>Estimate)])</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(slope_data, <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Estimated Random Slopes by Patient"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Patient ID"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Random Slope Estimate (log-CRP/day)"</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="M05_2_files/figure-html/crp_random_slope_intercept_plot-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To get the fitted lines for each individual we use the following R code:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> crp_data <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ID, Day, Age, Sex, Sepsis, Antibiotic, Discharg) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>fitted_values <span class="ot">&lt;-</span> <span class="fu">fitted</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  crp_model_random_slope,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> newdata,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">re_formula =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>fitted_df_log <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(newdata, <span class="fu">as_tibble</span>(fitted_values))</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fitted_df_log, <span class="fu">aes</span>(<span class="at">x =</span> Day, <span class="at">y =</span> Estimate, <span class="at">group =</span> ID, <span class="at">color =</span> ID)) <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"CRP Trajectories (log scale)  - Random Slope"</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Fitted CRP (log scale)"</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="M05_2_files/figure-html/crp_random_slope_intercept_fitted_plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="partial-pooling-with-only-random-slope" class="level2">
<h2 class="anchored" data-anchor-id="partial-pooling-with-only-random-slope">Partial Pooling with Only Random Slope</h2>
<iframe width="500" height="300" src="https://www.youtube.com/embed/FjmsJMOax_8" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
</iframe>
<p>Using partial pooling with only a random slope (and a fixed intercept) is a more targeted modelling choice. It means we’re assuming all groups start at the same baseline level, but respond differently to a predictor or covariate. This version of the partial pooling model removes the random intercept <span class="math inline">\(\beta_{0j}\)</span>, leaving only a random slope <span class="math inline">\(\beta_{1j}\)</span> for Day. Since there’s only one random effect, no correlation structure (like <span class="math inline">\(\rho\)</span>) is required. The model assumes each patient has their own trajectory over time (slope), but shares the same intercept.</p>
<section id="model-specification-1" class="level3">
<h3 class="anchored" data-anchor-id="model-specification-1">Model Specification</h3>
<p>Based on the concept described above, we write the hierarchical model with prior specifications as follows:</p>
<p><span class="math display">\[
\begin{aligned}
\text{log(CRP)}_{ij} &amp;\sim N(\beta_0 + (\beta_1 + \beta_{1j}) \cdot \text{Day}_{ij} + \mathbf{x}_{ij} \boldsymbol{\beta}, \sigma^2) \\
\beta_0, \beta_1 &amp;\sim N(0, 10^2) \\
\boldsymbol{\beta} &amp;\sim N(0, 10^2 I) \\
\beta_{1j}|\sigma_1 &amp;\sim N(0, \sigma_1^2) \\
\sigma_1, \sigma &amp;\sim \text{Half-Cauchy}(0, 1)
\end{aligned}
\]</span></p>
<p>Which can be drawn using the following DAG:</p>
<div class="cell">
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-4f45830fcbb942908a5a" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-4f45830fcbb942908a5a">{"x":{"diagram":"\n  digraph DAG {\n    rankdir = LR;\n    fontsize = 10;\n    node [fontname = Helvetica];\n\n    # Observed Data\n    CRP     [label = \"log(CRP[i,j])\", shape = ellipse, style = filled, fillcolor = lightcoral]\n    Day     [label = \"Day[i,j]\", shape = ellipse, style = filled, fillcolor = lightblue]\n    x       [label = \"x[i,j]\", shape = ellipse, style = filled, fillcolor = lightblue]\n\n    # Fixed Effects\n    beta_0  [label = \"β₀\\n(Global Intercept)\", shape = box, style = filled, fillcolor = lightgrey]\n    beta_1  [label = \"β₁\\n(Global Slope)\", shape = box, style = filled, fillcolor = lightgrey]\n    beta    [label = \"β\\n(Covariate Coefs)\", shape = box, style = filled, fillcolor = lightgrey]\n\n    # Priors for Fixed Effects\n    prior_beta_0 [label = \"Prior: β₀ ~ N(0, 10²)\", shape = box, style = dashed, fillcolor = lightyellow]\n    prior_beta_1 [label = \"Prior: β₁ ~ N(0, 10²)\", shape = box, style = dashed, fillcolor = lightyellow]\n    prior_beta   [label = \"Prior: β ~ N(0, 10² I)\", shape = box, style = dashed, fillcolor = lightyellow]\n\n    # Random Slope\n    beta_1j [label = \"β₁ⱼ\\n(Random Slope)\", shape = box, style = filled, fillcolor = lightyellow]\n\n    # Prior for Random Slope SD\n    sigma_1 [label = \"σ₁ ~ Half-Cauchy(0,1)\", shape = box, style = filled, fillcolor = seagreen1]\n\n    # Residual SD\n    sigma   [label = \"σ\\n(Residual SD)\", shape = box, style = filled, fillcolor = lightgrey]\n    prior_sigma [label = \"Prior: σ ~ Half-Cauchy(0,1)\", shape = box, style = dashed, fillcolor = lightyellow]\n\n    # Connections: Data\n    Day -> CRP\n    x   -> CRP\n\n    # Fixed Effects -> Outcome\n    beta_0 -> CRP\n    beta_1 -> CRP\n    beta   -> CRP\n\n    # Random Slope -> Outcome\n    beta_1j -> CRP\n\n    # Priors -> Parameters\n    prior_beta_0 -> beta_0\n    prior_beta_1 -> beta_1\n    prior_beta   -> beta\n    sigma_1      -> beta_1j\n    prior_sigma  -> sigma\n    sigma        -> CRP\n  }\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>From this DAG we can say, the outcome variable <span class="math inline">\(\text{log(CRP)}_{ij}\)</span> assumes a normal distribution. The mean structure includes a global intercept (<span class="math inline">\(\beta_0\)</span>) and global slope (<span class="math inline">\(\beta_1\)</span>), both of which have normal priors with large variance (<span class="math inline">\(N(0, 10^2)\)</span>), reflecting weakly informative prior. In addition to these fixed effects, the model includes covariates <span class="math inline">\(\mathbf{x}_{ij}\)</span>, which are associated with a coefficient vector <span class="math inline">\(\boldsymbol{\beta}\)</span>, also assumed to follow a multivariate normal prior with identity covariance scaled by <span class="math inline">\(10^2\)</span>.</p>
<p>To account for subject-level (or group-level) variation in the effect of time (e.g., “Day”), the model introduces a random slope <span class="math inline">\(\beta_{1j}\)</span>, which allows the slope of “Day” to vary by group <span class="math inline">\(j\)</span>. This random slope is drawn from a normal distribution with standard deviation <span class="math inline">\(\sigma_1\)</span>, which itself follows a Half-Cauchy(0,1) prior to constrain it to positive values and reflect uncertainty about its scale.</p>
<p>The model also includes a residual standard deviation parameter <span class="math inline">\(\sigma\)</span>, representing unexplained variability in the outcome. Like <span class="math inline">\(\sigma_1\)</span>, this parameter is given a Half-Cauchy(0,1) prior.</p>
</section>
<section id="r-stan-brm-example-1" class="level3">
<h3 class="anchored" data-anchor-id="r-stan-brm-example-1">R-Stan (brm) Example</h3>
<p>We use following R code to run the partial pooling model with only random slope, where we consider writing <code>(0 + Day | ID)</code> formula argument using <code>brm</code> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>crp_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"crp_data_complete.csv"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>crp_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ID =</span> crp_data<span class="sc">$</span>ID,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">CRP =</span> crp_data<span class="sc">$</span>crp,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">CRP_log =</span> <span class="fu">log</span>(crp_data<span class="sc">$</span>crp),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Day =</span> crp_data<span class="sc">$</span>day,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Antibiotic =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>antib_1h),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Age =</span> crp_data<span class="sc">$</span>age,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sex =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>SEX),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sepsis =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>SEPSIS),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Discharg =</span> <span class="fu">as.factor</span>(crp_data<span class="sc">$</span>discharge_r)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sd"</span>),           <span class="co"># for random slope</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)         <span class="co"># residual SD</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>crp_model_random_slope_only <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> CRP_log <span class="sc">~</span> Day <span class="sc">+</span> Age <span class="sc">+</span> Sex <span class="sc">+</span> Antibiotic <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> Day <span class="sc">|</span> ID),</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> crp_data,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> priors,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">3</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">prior_summary</span>(crp_model_random_slope_only, <span class="at">all =</span> <span class="cn">FALSE</span>), <span class="at">show_df =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>b ~ normal(0, 10)
Intercept ~ normal(0, 10)
&lt;lower=0&gt; sd ~ cauchy(0, 1)
&lt;lower=0&gt; sigma ~ cauchy(0, 1)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(crp_model_random_slope_only)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: CRP_log ~ Day + Age + Sex + Antibiotic + (0 + Day | ID) 
   Data: crp_data (Number of observations: 432) 
  Draws: 3 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 3000

Multilevel Hyperparameters:
~ID (Number of levels: 72) 
        Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Day)     0.18      0.02     0.15     0.21 1.00      653      760

Regression Coefficients:
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept         3.53      0.21     3.12     3.93 1.00     1722     2006
Day              -0.11      0.02    -0.16    -0.06 1.00      685     1087
Age              -0.01      0.00    -0.01    -0.00 1.00     1723     1803
SexMale          -0.55      0.10    -0.74    -0.36 1.00     1676     1983
AntibioticYes    -0.17      0.10    -0.36     0.01 1.00     1585     1992

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.50      0.02     0.47     0.54 1.00     3054     2380

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>slope_data <span class="ot">&lt;-</span> <span class="fu">ranef</span>(crp_model_random_slope_only)<span class="sc">$</span>ID[, , <span class="st">"Day"</span>] <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Estimate =</span> Estimate, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q2.5 =</span> Q2<span class="fl">.5</span>, </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q97.5 =</span> Q97<span class="fl">.5</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>slope_data<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="fu">factor</span>(slope_data<span class="sc">$</span>ID, <span class="at">levels =</span> slope_data<span class="sc">$</span>ID[<span class="fu">order</span>(slope_data<span class="sc">$</span>Estimate)])</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(slope_data, <span class="fu">aes</span>(<span class="at">x =</span> ID, <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Estimated Random Slopes by Patient"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Patient ID"</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Random Slope Estimate (log-CRP/day)"</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="M05_2_files/figure-html/crp_random_slope_only-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> crp_data <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ID, Day, Age, Sex, Sepsis, Antibiotic, Discharg) <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>fitted_values <span class="ot">&lt;-</span> <span class="fu">fitted</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  crp_model_random_slope_only,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> newdata,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">re_formula =</span> <span class="cn">NULL</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>fitted_df_log <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(newdata, <span class="fu">as_tibble</span>(fitted_values))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fitted_df_log, <span class="fu">aes</span>(<span class="at">x =</span> Day, <span class="at">y =</span> Estimate, <span class="at">group =</span> ID, <span class="at">color =</span> ID)) <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"CRP Trajectories (log scale) - Random Slope Only"</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Fitted CRP (log scale)"</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="M05_2_files/figure-html/crp_random_slope_only-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In our model, we estimate two main variance parameters that capture different sources of variability in the CRP measurements. First, the standard deviation of the random slope for Day across individuals is estimated to be about 0.18, with a 95% credible interval ranging from 0.15 to 0.21. This tells us that the effect of time (Day) on CRP levels varies somewhat from person to person. While there is a general trend captured by the global slope, individual trajectories differ around this average, reflecting meaningful heterogeneity in how CRP changes over time for different subjects.</p>
<p>The residual standard deviation, which represents variability in CRP that is not explained by either the fixed effects or the random slopes, is estimated to be approximately 0.5, with a 95% credible interval between 0.47 and 0.54. This residual variation captures other sources of noise or unexplained fluctuations in CRP measurements. Despite including several predictors and accounting for individual differences in the time effect, there remains substantial unexplained variation in CRP levels.</p>
<p>Both variance estimates are supported by high effective sample sizes and Rhat values equal to 1, indicating that our sampling and model convergence are reliable. Overall, these parameters highlight the importance of accounting for individual-level differences in the effect of time, as well as recognizing the inherent variability in CRP measurements that cannot be fully explained by our predictors.</p>
</section>
</section>
<section id="partial-pooling-with-binary-outcome" class="level2">
<h2 class="anchored" data-anchor-id="partial-pooling-with-binary-outcome">Partial Pooling with Binary Outcome</h2>
<iframe width="500" height="300" src="https://www.youtube.com/embed/y403_v1Te6U" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">
</iframe>
<p>In this section, we will explain the partial pooling model, when the outcome variable is binary. The hierarchy related to binary outcome variable model is same as we have already discussed earlier in this module. But the main difference is the use of logistic type hierarchical models. Let us now explain more using an example related to a trial related to toe nail infection.</p>
<section id="toe-nail-data" class="level3">
<h3 class="anchored" data-anchor-id="toe-nail-data">Toe Nail Data</h3>
<p>The toenail dataset originates from a randomised, double-blinded clinical trial investigating treatments for fungal toenail infection. A total of 378 subjects/patients were randomly assigned to one of two oral antifungal therapies: 250 mg/day of terbinafine or 200 mg/day of itraconazole. Patients were assessed at seven scheduled visits: weeks 0, 4, 8, 12, 24, 36, and 48. The primary outcome of interest is onycholysis, a condition characterised by the separation of the nail plate from the nail bed. For descriptive purposes and alignment with the study’s objectives, the visit weeks were converted to months.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>toe_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"toenail_data.csv"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>toe_data<span class="sc">$</span>treatment <span class="ot">&lt;-</span> <span class="fu">factor</span>(toe_data<span class="sc">$</span>treatment, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Terbinafine"</span>, <span class="st">"Itraconazole"</span>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>toe_data<span class="sc">$</span>outcome <span class="ot">&lt;-</span> <span class="fu">factor</span>(toe_data<span class="sc">$</span>outcome, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"None or Mild"</span>, <span class="st">"Moderate or Severe"</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>toe_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Patient_ID =</span> toe_data<span class="sc">$</span>patient,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Onycholysis =</span> toe_data<span class="sc">$</span>outcome,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Treatment =</span> toe_data<span class="sc">$</span>treatment,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Visit =</span> toe_data<span class="sc">$</span>visit,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Month =</span> toe_data<span class="sc">$</span>month</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>summary_table <span class="ot">&lt;-</span> toe_data <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Treatment, Onycholysis) <span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Count =</span> <span class="fu">n</span>(),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Avg_Month =</span> <span class="fu">mean</span>(Month, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Treatment) <span class="sc">%&gt;%</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Proportion =</span> Count <span class="sc">/</span> <span class="fu">sum</span>(Count))</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(summary_table, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">caption =</span> <span class="st">"Summary of Toe Data by Treatment and Onycholysis"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Summary of Toe Data by Treatment and Onycholysis</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Treatment</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Onycholysis</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Count</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Avg_Month</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Proportion</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Terbinafine</td>
<td style="text-align: left;">None or Mild</td>
<td style="text-align: right;">777</td>
<td style="text-align: right;">5.28</td>
<td style="text-align: right;">0.80</td>
</tr>
<tr class="even">
<td style="text-align: left;">Terbinafine</td>
<td style="text-align: left;">Moderate or Severe</td>
<td style="text-align: right;">194</td>
<td style="text-align: right;">2.21</td>
<td style="text-align: right;">0.20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Itraconazole</td>
<td style="text-align: left;">None or Mild</td>
<td style="text-align: right;">723</td>
<td style="text-align: right;">5.30</td>
<td style="text-align: right;">0.77</td>
</tr>
<tr class="even">
<td style="text-align: left;">Itraconazole</td>
<td style="text-align: left;">Moderate or Severe</td>
<td style="text-align: right;">214</td>
<td style="text-align: right;">2.74</td>
<td style="text-align: right;">0.23</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can summarised the severity of onycholysis (nail separation) by treatment group across all visits. For both itraconozole and terbinafine, the majority of observations fell into the mnne or mild category. In the itraconazole group, about 77% of visits showed none or mild onycholysis, with an average visit time of 5.3 months. The remaining 23% were classified as moderate or severe, and these cases tended to occur earlier, averaging around 2.7 months. Similarly, in the terbinafine group, about 80% of visits were none or mild, with a mean timing of 5.3 months. The moderate or severe cases made up 20%, occurring earlier on average, at around 2.2 months. These summary statistics suggest that more severe symptoms tend to be reported earlier in treatment, while milder outcomes are more common later on. This trend appears consistent across both treatment groups, though terbinafine shows a slightly higher proportion of mild cases.</p>
<p>Now, we will develop a model that can provide us more insights on the relationships.</p>
</section>
<section id="model-development" class="level3">
<h3 class="anchored" data-anchor-id="model-development">Model Development</h3>
<p>We have repeated measurements for each patient over time, which are likely to be correlated within individuals. To appropriately account for this intra-subject correlation, we employ a partial pooling model, especifically, a hierarchical model with random (varying) intercepts across patients. Here, the outcome variable is onycholysis, indicating the severity of nail separation. The exposure variable is the treatment group (itraconozole or terbinafine). We also include Month (time since baseline) as a covariate to capture temporal changes in outcome. The model can be written mathematically as:</p>
<p><span class="math display">\[
\text{Onycholysis}_{ij} \sim \text{Bernoulli}(p_{ij})
\]</span></p>
<p><span class="math display">\[
\text{logit}(p_{ij}) = \beta_0 + \beta_{0j} + \beta_1 \cdot \text{Treatment}_{ij} + \beta_2 \cdot \text{Month}_{ij}
\]</span></p>
<p><span class="math display">\[
\beta_{0j}|\sigma_0 \sim N(0, \sigma_0^2); \quad \sigma_0 \sim \text{Half-Cauchy}(0,1)
\]</span></p>
<p>where, <span class="math inline">\(i\)</span> is the repeated measurements (visits), and <span class="math inline">\(j\)</span> indexes patients. Following our learning in previous lecture, the term <span class="math inline">\(\beta_0\)</span> is the global intercept, and <span class="math inline">\(\beta_{0j}\)</span> is the random (or varying) intercept for patient <span class="math inline">\(j\)</span>. The term <span class="math inline">\(\beta_1\)</span> is the treatment effect, and <span class="math inline">\(\sigma_0^2\)</span> captures the between-patient variability. You can see, this model assumes that each patient has their own baseline risk (via <span class="math inline">\(\beta_{0j}\)</span>), while sharing information across the entire population through partial pooling.</p>
<div class="cell">
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-042a70dd6563c590f6b8" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-042a70dd6563c590f6b8">{"x":{"diagram":"\n  digraph DAG {\n    rankdir = LR;\n    node [fontname = Helvetica, fontsize = 10];\n\n    # Observed Variables\n    Treatment [label = \"Treatment[i,j]\", shape = ellipse, style = filled, fillcolor = lightblue]\n    Month     [label = \"Month[i,j]\", shape = ellipse, style = filled, fillcolor = lightblue]\n    Onycholysis [label = \"Onycholysis[i,j]\", shape = ellipse, style = filled, fillcolor = lightcoral]\n\n    # Model Parameters\n    beta_0  [label = \"β₀\\n(Fixed Intercept)\", shape = box, style = filled, fillcolor = lightgrey]\n    beta_1  [label = \"β₁\\n(Treatment Effect)\", shape = box, style = filled, fillcolor = lightgrey]\n    beta_2  [label = \"β₂\\n(Month Effect)\", shape = box, style = filled, fillcolor = lightgrey]\n    beta_0j [label = \"β₀ⱼ\\n(Random Intercept)\", shape = box, style = filled, fillcolor = lightyellow]\n    sigma_0 [label = \"σ₀²\\n(Patient Variance)\", shape = box, style = filled, fillcolor = seagreen1]\n\n    # Priors\n    prior_beta_0 [label = \"Prior: β₀ ~ N(0, 10²)\", shape = box, style = dashed, fillcolor = lightyellow]\n    prior_beta_1 [label = \"Prior: β₁ ~ N(0, 10²)\", shape = box, style = dashed, fillcolor = lightyellow]\n    prior_beta_2 [label = \"Prior: β₂ ~ N(0, 10²)\", shape = box, style = dashed, fillcolor = lightyellow]\n    prior_sigma_0 [label = \"Prior: σ₀ ~ Half-Cauchy(0,1)\", shape = box, style = dashed, fillcolor = lightyellow]\n\n    # Edges: Data to Outcome\n    Treatment -> Onycholysis\n    Month     -> Onycholysis\n\n    # Edges: Parameters to Outcome\n    beta_0  -> Onycholysis\n    beta_1  -> Onycholysis\n    beta_2  -> Onycholysis\n    beta_0j -> Onycholysis\n\n    # Priors to Parameters\n    prior_beta_0 -> beta_0\n    prior_beta_1 -> beta_1\n    prior_beta_2 -> beta_2\n    prior_sigma_0 -> sigma_0\n    sigma_0 -> beta_0j\n  }\n","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="r-stan-brm-example-2" class="level3">
<h3 class="anchored" data-anchor-id="r-stan-brm-example-2">R-Stan (brm) Example</h3>
<p>Based on the model we developed for the toenail data and research aims, we will now impliment the hierarchical model using R code.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>toe_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"toenail_data.csv"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>toe_data<span class="sc">$</span>treatment <span class="ot">&lt;-</span> <span class="fu">factor</span>(toe_data<span class="sc">$</span>treatment, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Itraconozole"</span>, <span class="st">"Terbinafine"</span>))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>toe_data<span class="sc">$</span>outcome <span class="ot">&lt;-</span> <span class="fu">factor</span>(toe_data<span class="sc">$</span>outcome, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"None or Mild"</span>, <span class="st">"Moderate or Severe"</span>))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>toe_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Patient_ID =</span> toe_data<span class="sc">$</span>patient,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Onycholysis =</span> toe_data<span class="sc">$</span>outcome,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Treatment =</span> toe_data<span class="sc">$</span>treatment,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Visit =</span> toe_data<span class="sc">$</span>visit,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Month =</span> toe_data<span class="sc">$</span>month</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>),  </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>),          </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sd"</span>)           </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>onycholysis_model <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> Onycholysis <span class="sc">~</span> Treatment <span class="sc">+</span> Month <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Patient_ID),</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> toe_data,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">bernoulli</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> priors,</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">3</span>,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.95</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">prior_summary</span>(onycholysis_model, <span class="at">all =</span> <span class="cn">FALSE</span>), <span class="at">show_df =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>b ~ normal(0, 10)
Intercept ~ normal(0, 10)
&lt;lower=0&gt; sd ~ cauchy(0, 1)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(onycholysis_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> Family: bernoulli 
  Links: mu = logit 
Formula: Onycholysis ~ Treatment + Month + (1 | Patient_ID) 
   Data: toe_data (Number of observations: 1908) 
  Draws: 3 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 3000

Multilevel Hyperparameters:
~Patient_ID (Number of levels: 294) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     4.09      0.39     3.38     4.94 1.00      820     1428

Regression Coefficients:
                     Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
Intercept               -1.46      0.44    -2.34    -0.66 1.01      545
TreatmentTerbinafine    -0.53      0.58    -1.67     0.60 1.01      531
Month                   -0.46      0.04    -0.53    -0.38 1.00     2807
                     Tail_ESS
Intercept                 943
TreatmentTerbinafine      935
Month                    2606

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>As we have discuss in our previous module, <code>brm</code> output provides the posterior estimates in log-odds scale. The summary results above indicates the posterior estimates in log-odds. Hence, we can use the following R code to convert it into odds ratio (i.e., <span class="math inline">\(\exp(.)\)</span>). The interpretation of the posterior estimates is similar to what we explained for a Bayesian logistic regression using odds ratios.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>onycholysis_model <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_regression</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fianeznbds" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#fianeznbds table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#fianeznbds thead, #fianeznbds tbody, #fianeznbds tfoot, #fianeznbds tr, #fianeznbds td, #fianeznbds th {
  border-style: none;
}

#fianeznbds p {
  margin: 0;
  padding: 0;
}

#fianeznbds .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#fianeznbds .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#fianeznbds .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#fianeznbds .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#fianeznbds .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fianeznbds .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fianeznbds .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#fianeznbds .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#fianeznbds .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#fianeznbds .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#fianeznbds .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#fianeznbds .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#fianeznbds .gt_spanner_row {
  border-bottom-style: hidden;
}

#fianeznbds .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#fianeznbds .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#fianeznbds .gt_from_md > :first-child {
  margin-top: 0;
}

#fianeznbds .gt_from_md > :last-child {
  margin-bottom: 0;
}

#fianeznbds .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#fianeznbds .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#fianeznbds .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#fianeznbds .gt_row_group_first td {
  border-top-width: 2px;
}

#fianeznbds .gt_row_group_first th {
  border-top-width: 2px;
}

#fianeznbds .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fianeznbds .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#fianeznbds .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#fianeznbds .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fianeznbds .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#fianeznbds .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#fianeznbds .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#fianeznbds .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#fianeznbds .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#fianeznbds .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fianeznbds .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fianeznbds .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#fianeznbds .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#fianeznbds .gt_left {
  text-align: left;
}

#fianeznbds .gt_center {
  text-align: center;
}

#fianeznbds .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#fianeznbds .gt_font_normal {
  font-weight: normal;
}

#fianeznbds .gt_font_bold {
  font-weight: bold;
}

#fianeznbds .gt_font_italic {
  font-style: italic;
}

#fianeznbds .gt_super {
  font-size: 65%;
}

#fianeznbds .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#fianeznbds .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#fianeznbds .gt_indent_1 {
  text-indent: 5px;
}

#fianeznbds .gt_indent_2 {
  text-indent: 10px;
}

#fianeznbds .gt_indent_3 {
  text-indent: 15px;
}

#fianeznbds .gt_indent_4 {
  text-indent: 20px;
}

#fianeznbds .gt_indent_5 {
  text-indent: 25px;
}

#fianeznbds .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#fianeznbds div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="gt_col_headings header">
<th id="label" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="estimate" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>exp(Beta)</strong></th>
<th id="conf.low" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">Treatment</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Itraconozole</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Terbinafine</td>
<td class="gt_row gt_center" headers="estimate">0.59</td>
<td class="gt_row gt_center" headers="conf.low">0.19, 1.82</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">Month</td>
<td class="gt_row gt_center" headers="estimate">0.63</td>
<td class="gt_row gt_center" headers="conf.low">0.59, 0.68</td>
</tr>
</tbody><tfoot class="gt_sourcenotes">
<tr class="odd">
<td colspan="3" class="gt_sourcenote">Abbreviation: CI = Credible Interval</td>
</tr>
</tfoot>

</table>

</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>intercept_data <span class="ot">&lt;-</span> <span class="fu">ranef</span>(onycholysis_model)<span class="sc">$</span>Patient_ID[, , <span class="st">"Intercept"</span>] <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"Patient_ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Estimate =</span> Estimate,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q2.5 =</span> Q2<span class="fl">.5</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Q97.5 =</span> Q97<span class="fl">.5</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>intercept_data<span class="sc">$</span>Patient_ID <span class="ot">&lt;-</span> <span class="fu">factor</span>(intercept_data<span class="sc">$</span>Patient_ID, <span class="at">levels =</span> intercept_data<span class="sc">$</span>Patient_ID[<span class="fu">order</span>(intercept_data<span class="sc">$</span>Estimate)])</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">#p1 &lt;- ggplot(intercept_data, aes(x = Patient_ID, y = Estimate)) +</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_point() +</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0.2) +</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  coord_flip() +</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">#  labs(</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">#    title = "",</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">#    x = "Patient ID",</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">#    y = "Estimate (Log-Odds)"</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">#  ) +</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  theme_minimal()</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co">#intercept_data &lt;- intercept_data %&gt;%</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co">#  mutate(Significant = ifelse(Q2.5 &gt; 0 | Q97.5 &lt; 0, "Yes", "No"))</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co">#p2 &lt;- ggplot(intercept_data, aes(x = Patient_ID, y = Estimate, color = Significant)) +</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_point() +</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0.2) +</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co">#  coord_flip() +</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="co">#  labs(</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co">#    title = "Significance Highlighted",</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co">#    x = "Patient ID",</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co">#    y = "Estimate (Log-Odds)",</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co">#    color = "Significant?"</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co">#  ) +</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="co">#  theme_minimal()</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co">#library(gridExtra)</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="co">#grid.arrange(p1,p2,col=2)</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="co">#library(patchwork)</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co">#p1 + p2 + </span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="co">#  plot_layout(ncol = 2) + </span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="co">#  plot_annotation(title = "Random (Varying) Effects")</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a><span class="co">#ggplot(intercept_data, aes(y = Patient_ID, x = Estimate)) +</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_point() +</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_errorbar(aes(ymin = Q2.5, ymax = Q97.5), width = 0.2) +</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a><span class="co">#  coord_flip() +</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="co">#  labs(</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="co">#    title = "",</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="co">#    y = "Patient ID",</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="co">#    x = "Estimate"</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="co">#  ) +</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="co">#  theme_minimal()</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>newdata <span class="ot">&lt;-</span> toe_data <span class="sc">%&gt;%</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Patient_ID, Month, Treatment) <span class="sc">%&gt;%</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>fitted_values <span class="ot">&lt;-</span> <span class="fu">fitted</span>(</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  onycholysis_model,</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> newdata,</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">re_formula =</span> <span class="cn">NULL</span>,  <span class="co"># Includes random effects</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>fitted_df <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(newdata, <span class="fu">as_tibble</span>(fitted_values))</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fitted_df, <span class="fu">aes</span>(<span class="at">x =</span> Month, <span class="at">y =</span> Estimate, <span class="at">group =</span> Patient_ID, <span class="at">color =</span> Patient_ID)) <span class="sc">+</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Q2<span class="fl">.5</span>, <span class="at">ymax =</span> Q97<span class="fl">.5</span>), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Probability of Moderate/Severe Onycholysis"</span>,</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Probability"</span>,</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Month"</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="M05_2_files/figure-html/toenail_model_oddsratio-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!--

## Hierarchical modelling applied to meta-analysis

ref: gelman sec 5.6, page 124

-->
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this lecture, we explored various hierarchical modelling approaches using partial pooling. We began with models that include both random (or varying) intercepts and slopes, followed by models with only random slopes, illustrating how these structures account for individual-level variation. We then extended the framework to binary outcomes, demonstrating how to implement Bayesian logistic hierarchical (or mixed-effects) models. Throughout, we provided practical examples and R code to help apply these methods to real-world data. These models allow us to make more accurate and generalisable inferences by borrowing strength across groups while accounting for within-group differences.</p>
</section>
<section id="live-tutorial-and-discussion" class="level2">
<h2 class="anchored" data-anchor-id="live-tutorial-and-discussion">Live tutorial and discussion</h2>
<p>The final learning activity for this week is the live tutorial and discussion. This tutorial is an opportunity for you to to interact with your teachers, ask questions about the course, and learn about biostatistics in practice. You are expected to attend these tutorials when possible for you to do so. For those that cannot attend, the tutorial will be recorded and made available on Canvas. We hope to see you there!</p>
</section>
<section id="tutorial-exercises" class="level2">
<h2 class="anchored" data-anchor-id="tutorial-exercises">Tutorial Exercises</h2>
<p>Solutions will be provided later after the tutorial.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-LEWANDOWSKI20091989" class="csl-entry" role="listitem">
Lewandowski, Daniel, Dorota Kurowicka, and Harry Joe. 2009. <span>“Generating Random Correlation Matrices Based on Vines and Extended Onion Method.”</span> <em>Journal of Multivariate Analysis</em> 100 (9): 1989–2001. https://doi.org/<a href="https://doi.org/10.1016/j.jmva.2009.04.008">https://doi.org/10.1016/j.jmva.2009.04.008</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./M05_1.html" class="pagination-link" aria-label="Week 9: **Cluster Smart with Bayes**">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Week 9: <strong>Cluster Smart with Bayes</strong></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./brief_module_06.html" class="pagination-link" aria-label="**Module 6:** Wander into the Wonder!">
        <span class="nav-page-text"><strong>Module 6:</strong> Wander into the Wonder!</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>